
改造版MACSDRVのそれなりの解説txt (β版)

------------------------------------------------------------------------------

キー操作一覧

SPACE/P     : 一時停止、一時停止解除 (トグル動作)
ESC         : 再生を中断する
←          : 1ステップ戻し
→          : 1ステップ送り (既に再生した場所までしか進めません)
[一時停止中に]
  ←        : 一時停止解除後に1ステップ戻る
  →        : コマ送り

T           : 最初に戻す (約1.5秒間黒画面のまま待機する処理も入ります)
↑↓        : 音量調整
テンキー0   : 音量をデフォルト値(中央)に戻す

UNDO        : 表示領域設定のオンオフ (トグル動作)
ROLLUP/DOWN : 表示領域の幅調整
HOME        : 表示領域の幅をデフォルト値(またはデータ内の指定値)に戻す
I           : ライン(ラスター)飛ばし間引き描画のオンオフ (トグル動作)

  ※PCM8A使用時、ステップ操作後に音量が変化する場合があるのは仕様です


------------------------------------------------------------------------------

追加オプション一覧


-m        測定機能を有効にする
-d        測定機能を無効にする (デフォルト)

        測定機能を有効にして動画を再生した後、macsinfo.xを起動すると表示項目が
        増加し、内部ルーチンの処理時間が細かく見られるようになります。
        ただし測定機能自体の負荷が比較的高めで再生が全体的に重くなります。


-f[0-2]
   -f0    自動フレームスキップを無効にする
   -f1    描画速度優先モードで自動フレームスキップを有効にする
   -f2    画像乱れ防止優先モードで自動フレームスキップを有効にする(デフォルト)

        通常は -f2 のままでお使い下さい。この自動フレームスキップ機能は
        無改造MACSデータの再生時には適用されません。


-i[0-5]
   -i0    間引き描画をオフにする        (デフォルト)
   -i1    1ライン飛ばして間引き描画する (再生中にIキーを押すのと同じ効果)
   -i2    2ライン描いて1ライン飛ばす    (黒枠処理に非対応)
   -i3    3ライン描いて1ライン飛ばす    (同上)
   -i4    画面の上下に強制的に黒枠を出して描画領域を狭める
   -i5    i1とi4を同時に設定する


-p[0|1]
   -p0    再生コントロールアイコンを表示しない
   -p1    再生コントロールアイコンを表示する (デフォルト)


-k[0-2]
   -k0    再生コントロールキーの操作をESCキーを含めて無効にする
   -k1    ESCキーのみ有効にし、他の再生コントロールキーの操作は無効にする
   -k2    全てのキー操作を有効にする (デフォルト)

        再生プレイヤー(MACSplay.x)側のキー入力完全無効オプション(-K)とは別枠で
        機能します。再生プレイヤー側でキー入力が無効に設定された場合はそちらが
        優先され、その逆の場合は MACSDRV改側の -k 設定が優先されます。

        -k0 指定時に再生を中断したい場合は SHIFT+ESCキーを同時に押して下さい。
        再生プレイヤー側でキー入力が無効に設定された場合の中断キーはありません。


-c[0-2]
   -c0    CALLコマンドを使用不可にし再生中断する
   -c1    CALLコマンドをスキップする (デフォルト)
   -c2    CALLコマンドの使用を許可する

        MACSデータ内で任意のプログラムを実行できる「CALLコマンド」というものが
        あります。現代の視点ではこれはトロイの木馬の作成が可能なコマンドですの
        で、CALLコマンドを含んだMACSデータは無改造版も含め、デフォルトでは実行
        できないように修正致しました。

        デフォルト設定 -c1 ではCALLコマンドはスキップされ、次のコマンドに進み
        ます。そのため本来の動作とは異なる状態でデータが再生されてしまう可能性
        が高いです。なお検出した場合は再生終了時に警告文が表示されます。

        使用不可オプション -c0 でCALLコマンドを検出した場合 データ再生は即時に
        中断され、その旨の警告文が表示されます。

        危険性が無いと判断され、データ作成者様の意図した状態で再生したい場合は
        -c2 「使用許可」に設定を変更して下さる様お願い致します。


------------------------------------------------------------------------------

追加スケジュールコマンド一覧


  MACSDRVオリジナルコマンドの詳細は MACS116/DataMaker/MACS_Sch.docを参照して
  下さい。


SCREEN_ON_G64K        : 256x256 65536色 グラフィックVRAM
SCREEN_ON_G256        : 256x256 256色   GVRAM
SCREEN_ON_G384        : 384x256 256色   GVRAM (※再生にはIPLROM1.6が必要です)
SCREEN_ON_T512        : 512x512 16色    テキストVRAM
SCREEN_ON_T512_C4     : 512x512 4色     TVRAM
SCREEN_ON_T768        : 768x512 1色     TVRAM
SCREEN_ON_T512_V256   : 512x256 16色    TVRAM
SCREEN_ON_T256        : 256x256 16色    TVRAM (※改造版)
SCREEN_ON_G256_V128   : 256x128 256色   GVRAM
SCREEN_ON_G384_V128   : 384x128 256色   GVRAM (※再生にはIPLROM1.6が必要です)

  使用したい拡張版画面モードを指定します。
  DRAWコマンド等を使用する前に記述して下さい。

  これらのコマンドは同じ動画データ内では一度だけしか使用できません。
  つまり、データの途中から画面モードを変更することはできません。

  これらの拡張版画面モードコマンドを使用した後、

        SET_POSITION
        BEFORE_COPY
        SCREEN_OFF
        PAN

  上記の4つのコマンドは正常動作しなくなりますので使用を禁止致します。



PCM_PLAY_S44 <PCMデータの相対アドレス>, <サイズ>
PCM_PLAY_S22

  PCM8PP用のPCM再生コマンドです。
  オリジナルのPCM_PLAYコマンドと使用方法は同じです。



PCM_PLAY_SUBADPCM <ADPCMデータの相対アドレス>, <サイズ>

  ADPCM用の再生コマンドです。
  PCM_PLAY_S22やS44コマンドと組み合わせて使用します。

  PCM8PPが常駐している時はこのSUBADPCMコマンドは無視され、PCM8PPの音声のみが
  再生されます。PCM8PPが常駐していない時はSUBADPCMコマンドが活性化し、ADPCMが
  再生されます。



SET_FPS <数値>

  このコマンドを実行すると、それ以後のWAIT 1から9までのコマンドが変化し、指定
  されたfpsに沿うようにWAITの値が自動的かつ強制的に変化します。
  つまりフレーム(画像データ)1枚1枚の表示間隔が指定されたfps値に合う様自動的に
  調整されるようになります。

  ただしWAIT 10以上の大き目の数値が指定されているWAITコマンドの場合は自動調整
  はされず、そのままの値でWAITが実行されます。

  指定する数値はfpsの1000倍の値です。24.0fpsにしたい場合は 24000を指定します。

  このコマンドは拡張版SCREEN_ON_G|Tコマンドの実行後から有効となります。
  映像の任意の場所で設定値を変更することができます。
  0 を指定するとSET_FPSコマンドは以後無効となります。

  よく使用されるfpsの数値をプリセットし、数値入力を不要にした下記のコマンドを
  MACS_SCH.h内に用意しております。

        SET_FPS15_X68     : 13.865fps  (CRT 31kHz / VSYNC÷4)
        SET_FPS15         : 15.0fps
        SET_FPS20_X68     : 18.486fps  (CRT 31kHz / VSYNC÷3)
        SET_FPS24_NTSC    : 23.976fps
        SET_FPS24         : 24.0fps
        SET_FPS30_X68     : 27.729fps  (CRT 31kHz / VSYNC÷2)
        SET_FPS30_NTSC    : 29.97fps
        SET_FPS30         : 30.0fps
        SET_FPS60_X68     : 55.458fps  (CRT 31kHz / =VSYNC)



SET_VIEWAREA_Y <数値>

  縦方向の表示領域(※中央揃え)を指定します。
  例えば縦256画面時に212を指定した場合は上下に22ドットずつが非描画領域＝黒枠
  となります。

  指定可能範囲 [2-256] (縦256ドット画面時：2ドット刻み)
               [8-512] (縦512ドット画面時：8ドット刻み ※512x256モードも含む)

  なおパレット0が黒ではないデータで表示領域指定を行うと画面が激しくフラッシュ
  することがあるので注意して下さい。
  また、「存在するデータを部分的に表示しない」コマンドのため、データそのものを
  あらかじめ表示領域に合わせて削ることは現在のところできません。



PCM_PAUSE
PCM_UNPAUSE

  PCM/ADPCMの一時停止と一時停止解除をします。



KEY_MODE <0から2>

  -k[0-2]と同じ効果ですが、このコマンドはこれを使用したデータを再生している間
  のみ有効なワンタイム設定となり、ドライバへの設定の保存はされません。
  KEY_MODE 0 を指定した場合の再生中断は SHIFT+ESCキーの同時押しで行って下さい。



CALLSETTING_GOTO <-cオプションの数値>, <アドレス>

  -c[0-2]の設定数値と第1引数が一致した時に指定したアドレスにジャンプします。

  ※アドレスにはラベルを指定して下さい。



INKEY_GOTO <キースキャンコード>, <アドレス>

  キースキャンコードに指定したキーが押されているとアドレスにジャンプします。
  キー入力が無い場合は素通りし、いわゆる入力待ちの一時停止はしません。

  このコマンドは KEY_MODE の影響を受けず。常にキーに反応します。再生コントロー
  ルとかぶるキーを認識させたい場合は、誤反応を防ぐために事前に KEY_MODE 1 を
  実行しておいて下さい。



TIME_GOTO <開始時刻>, <終了時刻>, <アドレス>

  X68000の本体時計が開始時刻から終了時刻までの間はアドレスにジャンプします。
  時刻の記述は24時間表記で '00:00:00' です。シングルクォーテーションで括って
  下さい。0時を跨ぐ場合は2行に分けて記述して下さい。

   例) TIME_GOTO '00:00:00','00:59:59', playdata2

   0時から1時までの間、「playdata2:」のラベルにジャンプします。



WEEK_GOTO <曜日(数値)>, <アドレス>

  本体カレンダーが指定された曜日だった場合はアドレスにジャンプします。
  曜日指定は日曜日が 0、土曜日が 6 となります。



DATE_GOTO <日>, <アドレス>

  本体カレンダーが指定された日だった場合はアドレスにジャンプします。
  日の指定は 1 から 31 です。



MONTH_GOTO <月>, <アドレス>

  本体カレンダーが指定された月だった場合はアドレスにジャンプします。
  月の指定は 1 から 12 です。



YEAR_GOTO <西暦>, <アドレス>

  本体カレンダーが指定された年だった場合はアドレスにジャンプします。
  西暦の指定は 1980 から 2079 までです。



RANDOM_GOTO <アドレス1>, <アドレス2>, …

  指定された複数のアドレスのどれかにランダムでジャンプします。
  指定可能なアドレスの総数は 20 です。(※仕様上の上限は256)

   例) RANDOM_GOTO playdata1, playdata2, playdata3

   3つ書いたどれかのラベルにランダムでジャンプします。



LOOP <ループ回数(2から32767まで)>
LOOPEND

  LOOPとLOOPENDの間のコマンドを回数分繰り返します。音声は繰り返しません。



LOOP_WA <ループ回数(2から32767まで)>
LOOPEND_WA

  LOOP_WAとLOOPEND_WAの間のコマンドを回数分、音声もループ開始時まで戻しつつ
  繰り返します。LOOP~LOOPENDのWith Audio版。



------------------------------------------------------------------------------

テンプレlist.sの解説

※この例は 画像データ[Tx10000.lzs / Tp10000]から[Tx10999.lzs / Tp10999]までの
  1000x2ファイルを先に作成してあるものとします。

i=10000
        .rept   1000            ← 画像データの総枚数をここに入れて下さい
        .quad
Tx%i:: .insert Tx%i.lzs         ← lzsaを使う場合はこのままでOKです
                                   無圧縮データを使用したい場合は拡張子を
                                   削除して下さい。
;Tx%i:: .insert Tx%i.lze        ← lzeを使う場合はこの行のコメント[;]を外し、
                                   lzsa(.lzs)の行は削除かコメント化して下さい
        .even                   ← これがないと68000では高確率でアドレスエラー
                                   が発生します
Tp%i:: .insert Tp%i
i=i+1
        .endm

pcmdat:: .insert ad.s22         ← S44を使用したい場合はs44に書き換えて下さい
pcmend::                        ← PCM8PPを使用しない場合はこの2行は削除か
                                   コメント化して下さい
adpcmdat:: .insert ad.pcm
adpcmend::


------------------------------------------------------------------------------

テンプレMACSsrc.sの解説

.include MACS_SCH.h             ← スケジュールコマンドがつまっています

SET_OFFSET                      ← これを必ず最初に書くのがMACSのお約束です

USE_DUALPCM 'S22'               ← 使用するPCMやADPCMの宣言文。なくてもいい
TITLE   'ふんぎゃろ'            ← タイトルの埋め込み。ふんにゃか はんにゃか
COMMENT '256x256 256colors'     ← コメントの埋め込み。ご自由に

SCREEN_ON_G256                  ← 拡張版の画面モードを指定します
SET_FPS24_NTSC                  ← fpsの指定をします
;SET_VIEWAREA_Y 214             ← 画面上下を黒枠にしたい時はコメント[;]を外す

DRAW_DATA_RP 10000              ← 画像データの通し番号の最初の数字をここに
                                   入れます

PCM_PLAY_S22 pcmdat,pcmend-pcmdat
PCM_PLAY_SUBADPCM adpcmdat,adpcmend-adpcmdat
                    ↑ PCM/ADPCM再生コマンドです。
                       S44を使用したい場合は「PCM_PLAY_S44」に書き換えて下さい
                       PCM8PPを使用しない場合は「PCM_PLAY_S22」行を削除し、
                       「PCM_PLAY_SUBADPCM」を「PCM_PLAY」に書き換えて下さい

DRAW_DATA 10001,10999           ← 画像データの最後の番号を第2引数に入れます

WAIT 60                         ← 映像の最後の待ち時間を指定します
PCM_STOP                        ← PCM/ADPCMの再生を停止します
EXIT                            ← おわり


------------------------------------------------------------------------------

MACSIOCS追加コール一覧

  d1.w = 14     自動フレームスキップの有効/無効を設定します
                d2.wが0なら無効、1なら有効。2で厳格な基準で有効、
                -1で現在の状態をd0.lに返します。
                   0 = 描画が遅れても無視して放置する
                   1 = 1フレーム弱遅れた程度ならティアリング上等で描画を続ける
                   2 = ほんのちょっとでも遅れたら描画をスキップする
                初期値は 2 です。
                互換性維持のため追加された画面モードのみの対応です。

  d1.w = 15     開始時に挿入される約1.5秒待ち処理の有効/無効を設定します
                d2.wが0なら無効、1なら有効、-1で現在の状態をd0.lに返します。
                設定初期値は 1 です。
                1.5秒待ち処理は追加された画面モードのみの対応です。

  d1.w = 16     動画のフレーム関係ワークエリアのアドレスをd0.lに返します
                ワークエリアには直前に再生した動画の数値が納まっています
                   offset + $00.l : 動画再生中の垂直同期の積算数
                          + $04.l : 動画の総フレーム数
                          + $08.l : 動画のドロップフレーム数
                            (以降はmacsinfo.c内の定義を参照して下さい)
                このワークエリアは追加された画面モードのみの対応です。

  d1.w = 17     MACS改造バージョン検査
                d0.lに常駐しているMACSの改造バージョン番号をBCDで返します。
                (v0.15.11なら$0000_15_11)
                このコールは[MACSバージョン検査 d1.w=3]コマンドで取得できる
                内部バージョン返値が $0123 から対応します。


------------------------------------------------------------------------------

改造バージョン履歴

0.22
・lze展開の最適化。
・create/template/LIST.sをlzeデフォルト仕様に変更した。

0.21
・フレーム統計を取り次のフレームの表示タイミング制御を行う処理を追加した。
   (Thanks カタ)
・0.20で入れたWAIT無視処理は場当たり的で互換性を無視している点が気になったた
  め、想定より早く出現するコマンドよりも先に初期化を済ませ、正常にコマンドが
  通るように修正した。
・拡張画面モードを68000に対応させた。
・初期化処理に不備があったので修正した。(Thanks カタ＆X68PRO)
・RANDOM_GOTOの疑似乱数をまともにした。(Thanks X68PRO)
・KEY_MODE 0を使用できるように仕様を変更した。(Thanks X68PRO)

0.20
・SET_FPSコマンドで指定したfps通りに表示されない不具合を修正した。
  しかしこの不具合はこれまでの（SET_FPSを使用していないデータや無改造MACS版
  データも含め）全てのデータの再生速度に影響を与えており、素直に修正すること
  ができない状態にあることも判明したため、DataVer=1.30未満のデータを再生した
  場合は不具合をわざとエミュレート的な手法で再現させ、表示速度に影響が出ない
  よう互換を取る処理を加えた。(Thanks みゆ (miyu rose))
・後方互換性確保のため 0.19 で導入した「局所的な表示タイミングずれ」の修正を
  DataVer=1.30未満のデータには適用しないように再修正した。
  (Thanks カタ、みゆ (miyu rose))
・初期化前に設置されたWAITコマンドを無視するようにした。(Thanks カタ)

0.19
・分岐やループ系コマンドをいくつか追加した
・無圧縮データを自動認識するようにした(※lzeに識別子が無いためにlzeと間違えて
  誤作動が起きる可能性がある)
・pause中にコマ送りができなくなっていた不具合の修正
・確保したハイメモリの領域を超えて書き込んでいた不具合の修正
・MACS_SCH.hコマンド追加に伴い内部バージョンの変更(v1.27)
・元映像との表示タイミングずれが局所的に大きくなることがある不具合の修正
・crtmod16.xに対応した

0.18
・圧縮展開ルーチンをハイメモリ上に転送し実行するようにした
・常駐時にもオプションが指定できるようにした
・キー入力ベクタを使用しないようにした(※無改造MACSとの明確な非互換部分になる)
・再生コントロールキー使用可/不可の設定オプションを追加した
・pause中に音量コントロールができるように修正
・脆弱性対策のため、CALLコマンドの実行制御オプションを追加した
・CALLコマンド不許可設定時にCALLコマンドを検出した場合、警告を出して再生を
  強制停止するようにした
・CALLコマンドのスキップを実装した(Thanks みゆ a^･ω･^a (miyu rose))
・MACS_SCH.hコマンド追加に伴い内部バージョンの変更(v1.26)

0.17
・256x128 256色と384x128 256色モードを追加した
・再生コントロールアイコンとか音量バーを表示させるようにした
・大きなWAITの実行中に再生コントロールキーの一部が反応するようにした
・コントロールアイコンを小さめにした(※384x256モード時に大きいのは仕様)
・384x256モードでコントロールアイコンの表示が崩れる不具合を修正
・MACS_SCH.hコマンド追加に伴い内部バージョンの変更(v1.25)

0.16
・IPLROM1.6を検出していることを常駐時に表示するようにした
・256色モードにて総フレーム数が奇数枚の動画を再生すると最終フレームが
  表示されない不具合の修正
・音量をキー操作では限界まで上げられないようにした
・-i オプション修正
・MACS_SCH.hコマンド追加に伴い内部バージョンの変更(v1.24)

0.15
・外部アプリケーション用に改造バージョンの取得コマンドを追加
・MACS_SCH.h内のコマンドを統合・整理

0.14
・256色モード時に頭まで再生を戻した後から表示シーケンスが乱れる不具合を修正
・頭まで戻すとVRAM保存に失敗する不具合を修正
・256色モード時の表示タイミングに問題があったので修正
・メインメモリに余裕がある時はVRAMとパレットを保存するようにした
・fps指定コマンドを追加

0.13
・時間測定機能を追加

0.12
・256色2フレーム単位描画モード時のフレーム同士の繋ぎ部分がなめらかになるように
  修正
・256x256 256色用の新データ形式に対応させた（が後に新形式自体を没にした）
・256色データの再生を50%程度高速化させた

0.11
・動画再生コントロールを追加

0.10
・68060最適化を操作するオプションの追加(※実験用オプション)
・ESCキーかマウス右クリックを押した時のみ再生を中断するように変更
・ワーク初期化を忘れてvsync積算数がふらついていた不具合を修正
・SUBADPCM命令使用時にPCM8Aを自動検出し、ADPCMをIOCSではなくtrapで制御するよう
  に変更
・常駐後に自動フレームスキップ設定を変更するオプションを追加

0.9
・IOCS $D0 (MACSIOCS)にエントリを追加
・データ表示開始直前に約1.5秒待機するように修正
  （ディスプレイのモード切替時間の確保）
・最初の1コマ目の表示準備が遅れた際にvsyncを無視して次に行ってしまう不具合の
  修正

これより前は地の底(素直に忘れたと言おう)
------------------------------------------------------------------------------
